version: '3.9'

services:
  # =======================
  # üñ• FRONTEND
  # =======================
  frontend:
    build: ./frontend
    container_name: localrag_frontend
    ports:
      - "8501:8501"
    depends_on:
      - pdf_microservice
      - rag_microservice
      - chat_microservice
    environment:
      - PDF_SERVICE_URL=http://pdf_microservice:8001
      - RAG_SERVICE_URL=http://rag_microservice:8002
      - CHAT_SERVICE_URL=http://chat_microservice:8003
      - PUSHGATEWAY_URL=http://pushgateway:9091
    restart: unless-stopped
    networks:
      - localrag_net

  # =======================
  # üìÑ PDF Microservice
  # =======================
  pdf_microservice:
    build: ./microservices/pdf_microservice
    container_name: pdf_microservice
    ports:
      - "8001:8001"
    restart: unless-stopped
    networks:
      - localrag_net

  # =======================
  # üß† RAG Microservice
  # =======================
  rag_microservice:
    build: ./microservices/rag_microservice
    container_name: rag_microservice
    ports:
      - "8002:8002"
    volumes:
      - ./ollama_data:/root/.ollama  # persist Ollama model cache
    environment:
      - OLLAMA_HOST=0.0.0.0
    restart: unless-stopped
    networks:
      - localrag_net

  # =======================
  # üí¨ Chat Microservice
  # =======================
  chat_microservice:
    build: ./microservices/chat_microservice
    container_name: chat_microservice
    ports:
      - "8003:8003"
    restart: unless-stopped
    networks:
      - localrag_net

  # =======================
  # üìä Monitoring Stack
  # =======================
  pushgateway:
    image: prom/pushgateway
    container_name: pushgateway
    ports:
      - "9091:9091"
    restart: unless-stopped
    networks:
      - localrag_net

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    depends_on:
      - pushgateway
    restart: unless-stopped
    networks:
      - localrag_net

  grafana:
    image: grafana/grafana
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
    restart: unless-stopped
    networks:
      - localrag_net

# =======================
# üåê Shared Network
# =======================
networks:
  localrag_net:
    driver: bridge
