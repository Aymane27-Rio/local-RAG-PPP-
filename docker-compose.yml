version: '3.9'

services:
  # =======================
  # 🖥 FRONTEND
  # =======================
  frontend:
    build: ./frontend
    container_name: localrag_frontend
    ports:
      - "8501:8501"
    depends_on:
      - pdf_microservice
      - rag_microservice
      - chat_microservice
    environment:
      - PDF_SERVICE_URL=http://pdf_microservice:8001
      - RAG_SERVICE_URL=http://rag_microservice:8002
      - CHAT_SERVICE_URL=http://chat_microservice:8003
      - PUSHGATEWAY_URL=http://pushgateway:9091
    restart: unless-stopped
    networks:
      - localrag_net

  # =======================
  # 📄 PDF Microservice
  # =======================
  pdf_microservice:
    build: ./microservices/pdf_microservice
    container_name: pdf_microservice
    ports:
      - "8001:8001"
    restart: unless-stopped
    networks:
      - localrag_net

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ./ollama_data:/root/.ollama  # persist models
    restart: unless-stopped
    networks:
      - localrag_net

  # =======================
  # 🧠 RAG Microservice
  # =======================
  rag_microservice:
    build: ./microservices/rag_microservice
    container_name: rag_microservice
    ports:
      - "8002:8002"
    environment:
      - OLLAMA_HOST=http://ollama:11434
    depends_on:
      - ollama
    restart: unless-stopped
    networks:
      - localrag_net


  # =======================
  # 💬 Chat Microservice
  # =======================
  chat_microservice:
    build: ./microservices/chat_microservice
    container_name: chat_microservice
    ports:
      - "8003:8003"
    restart: unless-stopped
    networks:
      - localrag_net

  # =======================
  # 📊 Monitoring Stack
  # =======================
  pushgateway:
    image: prom/pushgateway
    container_name: pushgateway
    ports:
      - "9091:9091"
<<<<<<< HEAD
    restart: unless-stopped
    networks:
      - localrag_net
=======
>>>>>>> b9adfce1630f5398fff971ea2f73482b1527b9af

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    volumes:
<<<<<<< HEAD
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
=======
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
>>>>>>> b9adfce1630f5398fff971ea2f73482b1527b9af
    ports:
      - "9090:9090"
    depends_on:
      - pushgateway
<<<<<<< HEAD
    restart: unless-stopped
    networks:
      - localrag_net
=======
>>>>>>> b9adfce1630f5398fff971ea2f73482b1527b9af

  grafana:
    image: grafana/grafana
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
<<<<<<< HEAD
    restart: unless-stopped
    networks:
      - localrag_net

# =======================
# 🌐 Shared Network
# =======================
networks:
  localrag_net:
    driver: bridge
=======
>>>>>>> b9adfce1630f5398fff971ea2f73482b1527b9af
